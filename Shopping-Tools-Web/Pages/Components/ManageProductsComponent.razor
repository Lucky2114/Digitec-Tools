@inject IModalService Modal
@using Microsoft.AspNetCore.Components
@using Shopping_Tools_Api_Services.Models
@using Shopping_Tools_Api_Services.Core.Digitec
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject Storage StorageInjected
@inject IMatToaster Toaster

<div class="container">
    @if (_loading)
    {
        <div style="width: 100%; padding-top: 1rem;">
            <MatProgressBar Indeterminate="true"></MatProgressBar>
        </div>
    }
    @if (_products?.Count > 0)
    {
        <MatTable Items="@_products" class="mat-elevation-z5">
            <MatTableHeader>
                <th>
                    <div>Product Id</div>
                </th>
                <th>
                    <div>Product Name</div>
                </th>
                <th>
                    <div>Product Link</div>
                </th>
                <th>
                    <div>Delete</div>
                </th>
            </MatTableHeader>
            <MatTableRow>
                <td>@context.ProductIdSimple</td>
                <td style="width: 40% !important;">
                    <strong>@context.Brand</strong> @context.Name
                </td>
                <td style="width: 100% !important;">@context.Url</td>
                <td>
                    <div class="align-content-center">
                        <button class="btn btn-danger" @onclick="@(e => RemoveProduct(context))">
                            Delete
                        </button>
                    </div>
                </td>
            </MatTableRow>
        </MatTable>
    }
    else
    {
        <div class="align-content-center justify-content-center text-center">
            <br/>
            <br/>
            <h2>No Data Available</h2>
        </div>
    }

    <MatButton OnClick="@ShowModal" Raised="true">Add New Product</MatButton>

</div>

@code {

    [Parameter]
    public IApi Shop { get; set; }

    private List<Product> _products = new List<Product>();
    private bool _loading = true;

    protected override async Task OnParametersSetAsync()
    {
        await UpdateProductsTable();
    }

    private async Task UpdateProductsTable()
    {
        _loading = true;
        this.StateHasChanged();
        _products = await StorageInjected.GetProductsForUser(AuthenticationStateProvider, Shop);
        _loading = false;
        this.StateHasChanged();
    }

    private async Task RemoveProduct(Product product)
    {
        await StorageInjected.RemoveUserFromProduct(product, AuthenticationStateProvider);
        await UpdateProductsTable();
    }

    private void ShowModal()
    {
        Modal.OnClose += ModalClosed;
        var modalParams = new ModalParameters();
        modalParams.Add("OnlineShop", Shop);

        Modal.Show<RegisterProductComponent>("Register A New Product", modalParams);
    }

    private async void ModalClosed(ModalResult modalResult)
    {
        if (!modalResult.Cancelled)
        {
            await UpdateProductsTable();
            StateHasChanged();
            Toaster.Add("Product Successfully Registered!", MatToastType.Success);
            return;
        }
        Toaster.Add("An Error occured while trying to register the product.", MatToastType.Danger);
        StateHasChanged();
    }

}

